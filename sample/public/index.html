<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<script>
    window.publicKey = 'eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJUdEZzelc3NDB2NTQ1MThVUVg1MGNnczN1U2pCSXkxbDdGcDVyMHdmYzFrIn0.eyJqdGkiOiI4MGFjYmY3Zi0zOGZlLTQ5NWMtODBjMS05Y2JkYTAxM2NkOWEiLCJleHAiOjAsIm5iZiI6MCwiaWF0IjoxNDg3MTYxNzk2LCJpc3MiOiJodHRwOi8vYXV0aC5yYmsudGVzdDo4MDgwL2F1dGgvcmVhbG1zL2V4dGVybmFsIiwiYXVkIjoidG9rZW5pemVyIiwic3ViIjoiNjM2OTZmMzUtOGUwOC00YzM2LTgyNTQtNGUxMDMxN2RmNWI2IiwidHlwIjoiT2ZmbGluZSIsImF6cCI6InRva2VuaXplciIsIm5vbmNlIjoiYWE0ZmFlNjQtYjAxOC00YTQzLThmZDMtNjNkZTQwYjkxMmQ2IiwiYXV0aF90aW1lIjowLCJzZXNzaW9uX3N0YXRlIjoiMjRiNzgwMDktMjE0Yi00NmQ3LWExMzctYTYzZmJjNjc3YjVjIiwiY2xpZW50X3Nlc3Npb24iOiIzYTUzY2U5NC1hOTdlLTRjMDUtYjgyMC02ODI0OWUxM2I0YjIiLCJyZWFsbV9hY2Nlc3MiOnsicm9sZXMiOlsib2ZmbGluZV9hY2Nlc3MiXX0sInJlc291cmNlX2FjY2VzcyI6eyJjb21tb24tYXBpIjp7InJvbGVzIjpbInBheW1lbnRfdG9vbF90b2tlbnM6Y3JlYXRlIl19fX0.Tj6bI5_8Q81MWR695FAXpfg_4enYOH1pMtA5kcd90dcjNeUKyFcspNRWUJTHJcHg9UHKCLMj7c1o1jbpK3bUzVsPO4GGGGCzB-qI9ZpTA5wW2cTUkpU9HHqyAaIYE2UoWMd6_0eYYKzgoO8Hzq9G4uGffvTV3kcufLQGdyiOMyvnUKKZs0OTl5tKVbiGaw-SY7NuDwd0qkLNIUHYuRD1u6S-bXhjplivGfdo5qJaBQkiqPiopR2Iy9ajUCYuaG7FFdoduwC64JKT25yfrCjVlGP_kMN4WkcMJd5vH-zEuXzdSL3YHqUh_I1uvLUo5eADaMQzt6JiwJmpggSvUQnuiw';

    function getDueDate(date) {
        const checkFormat = (input) => {
            let formatted = String(input);
            if(formatted.length < 2) {
                formatted = '0' + formatted;
            }
            return formatted;
        };

        const year = date.getFullYear();
        const month = checkFormat(date.getMonth() + 1);
        const day = checkFormat(date.getDate() + 1);
        const hours = checkFormat(date.getHours());
        const minutes = checkFormat(date.getMinutes());
        const seconds = checkFormat(date.getSeconds());

        return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes + ':' + seconds + 'Z';
    }

    function getInvoiceId() {
        const invoiceArgs = {
            shopID: 1,
            amount: 10000,
            currency: 'RUB',
            dueDate: getDueDate(new Date()),
            product: 'test',
            description: 'test',
            metadata: {}
        };

        const request = new XMLHttpRequest();
        request.onreadystatechange = function() {
            if(request.readyState === 4 && request.status >= 200 && request.status < 300) {
                let invoice =  JSON.parse(request.responseText);
                initPayButton(invoice);
            }
        };
        request.open('POST', 'http://localhost:8001/create_invoice', true);
        request.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
        request.send(JSON.stringify(invoiceArgs));
    }

    function initPayButton(invoice) {
        document.getElementById('invoicebutton').style.display = 'none';

        const script = document.createElement('script');
        script.setAttribute('src', 'http://localhost:7050/payframe/payframe.js');
        script.setAttribute('class', 'rbkmoney-checkout');
        script.setAttribute('data-key', window.publicKey);
        script.setAttribute('data-invoice-id', invoice.id);
        script.setAttribute('data-order-id', '1');
        script.setAttribute('data-amount', String(Number(invoice.amount) / 100));
        script.setAttribute('data-currency', invoice.currency);
        script.setAttribute('data-endpoint-init', 'http://localhost:8001/init_endpoint');
        script.setAttribute('data-endpoint-events', 'http://localhost:8001/events_endpoint');
        script.setAttribute('data-endpoint-success', 'http://localhost:8000/integrations/trynow');
        script.setAttribute('data-endpoint-failed', 'http://localhost:8000/integrations/trynow');
        script.setAttribute('data-name', 'Company name');
        script.setAttribute('data-logo', 'http://127.0.0.1:7051/logo.png');
        document.body.appendChild(script);
    }
</script>

<input id="invoicebutton" type="button" value="get InvoiceId" onclick="getInvoiceId()" style="
    display: block;
    width: 100px;
    height: 40px;
    border: 1px solid black;
    border-radius: 2px;
    padding: 3px;
">

</body>
</html>
