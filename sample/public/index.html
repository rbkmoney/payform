<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <style>
        #invoiceButton {
            display: block;
            width: 100px;
            height: 40px;
            border: 1px solid black;
            border-radius: 2px;
            padding: 3px;
        }
    </style>

    <script>
        (function(){
            let publicKey = '';

            function makeRequest(method, url, body, onSuccess, sync) {
                const request = new XMLHttpRequest();
                request.onreadystatechange = function() {
                    if(request.readyState === 4 && request.status >= 200 && request.status < 300) {
                        let result =  JSON.parse(request.responseText);
                        onSuccess(result);
                    }
                };
                request.open(method, url, !sync);
                request.setRequestHeader('Content-Type', 'application/json;charset=utf-8');
                request.send(body ? JSON.stringify(body) : null);
            }

            function getDueDate(date) {
                const checkFormat = (input) => {
                    let formatted = String(input);
                    if(formatted.length < 2) {
                        formatted = '0' + formatted;
                    }
                    return formatted;
                };

                const year = date.getFullYear();
                const month = checkFormat(date.getMonth() + 1);
                const day = checkFormat(date.getDate() + 1);
                const hours = checkFormat(date.getHours());
                const minutes = checkFormat(date.getMinutes());
                const seconds = checkFormat(date.getSeconds());

                return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes + ':' + seconds + 'Z';
            }

            function getInvoice() {
                const invoiceArgs = {
                    shopID: 1,
                    amount: 10000,
                    currency: 'RUB',
                    dueDate: getDueDate(new Date()),
                    product: 'test',
                    description: 'test',
                    metadata: {}
                };

                makeRequest('POST', 'http://localhost:8001/invoice', invoiceArgs, function(invoice) {
                    document.getElementById('invoiceButton').style.display = 'none';
                    initPayButton(invoice);
                });
            }

            function initPayButton(invoice) {
                const script = document.createElement('script');
                script.setAttribute('src', 'http://localhost:7050/payframe/payframe.js');
                script.setAttribute('class', 'rbkmoney-checkout');
                script.setAttribute('data-key', publicKey);
                script.setAttribute('data-invoice-id', invoice.id);
                script.setAttribute('data-order-id', '1');
                script.setAttribute('data-amount', String(Number(invoice.amount) / 100));
                script.setAttribute('data-currency', invoice.currency);
                script.setAttribute('data-endpoint-init', 'http://localhost:8001/init');
                script.setAttribute('data-endpoint-events', 'http://localhost:8001/events');
                script.setAttribute('data-endpoint-success', 'http://localhost:8000/success');
                script.setAttribute('data-endpoint-failed', 'http://localhost:8000/error');
                script.setAttribute('data-name', 'Company name');
                script.setAttribute('data-logo', 'http://127.0.0.1:7051/logo.png');
                document.body.appendChild(script);
            }

            makeRequest('GET', 'http://localhost:7051/settings', null, function(result) {
                publicKey = result.publicKey;
            }, true);

            window.getInvoice = getInvoice;
        })();
    </script>
</head>
<body>

    <input id="invoiceButton" type="button" value="get Invoice" onclick="getInvoice()">

</body>
</html>
